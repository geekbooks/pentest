/*
 *  network/examples/tcp-server.c
 * 
 *  Copyleft (C) 2015  Sun Dro (a.k.a 7th Ghost)
 *
 * Example source code of TCP Server.
 */

/* C-ს ჰედერები*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>

/* Linux-ის ჰედერები */
#include <sys/socket.h>
#include <arpa/inet.h>

int main()
{
    static struct sockaddr_in peer;
    int sock, newsock, ret;
    struct sockaddr_in name;
    socklen_t len;
    char buf[1024];
    int16_t port = 9999;

    /* შევქმნათ სოკეტი */
    sock = socket (PF_INET, SOCK_STREAM, 0);
    if (sock < 0)
    {
        perror("socket");
        exit(-1);
    }

    /* მივცეთ ჩვენს სოკეტს სახელი */
    name.sin_family = AF_INET;
    name.sin_port = htons (port);
    name.sin_addr.s_addr = htonl (INADDR_ANY);

    /* დავბინდოთ სოკეტი */
    if (bind(sock, (struct sockaddr *) &name, sizeof(name)) < 0)
    {
        perror("bind");
        exit(-1);
    }

    /* მოვუსმინოთ სოკეტს */
    if (listen(sock, 1) < 0)
    {
        perror("listen");
        exit(-1);
    }
    printf("[*] Server started listen at port: %d\n", port);

    while(1) 
    {
        /* Accept */
        len = sizeof(struct sockaddr);
        newsock = accept(sock, (struct sockaddr *) &peer, &len);
        if (newsock > 0) 
        {
            /* წავიკითხოთ მონაცემები სოკეტიდან */
            ret = read(newsock, buf, sizeof(buf));
            if (ret > 0) 
            {
                printf("Received: \n%s", buf);

                /* დავუბრუნოთ პასუხად იგივე */
                send(newsock, buf, strlen(buf), 0);
                printf("Send: \n%s", buf);
            }
        }
        close(newsock);
    }

    return 0;
}